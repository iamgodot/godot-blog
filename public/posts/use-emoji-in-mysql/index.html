<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Use emoji in MySQL | Godot&#39;s Blog</title>
<meta name="keywords" content="" />
<meta name="description" content="最近碰到一个服务器处理请求报错，但是本身的代码逻辑没有问题，排查后发现原来是参数中包含了 emoji，导致向 MySQL 插入数据时失败了。
解决起来倒是不麻烦，因为业务上不要求做相关的支持，所以捕捉异常之后返回错误码也就好了。但是好奇之下，做了个 MySQL 插入 emoji 的实验，发现里面还是有不少门道的。
What&rsquo;s emoji 🧐 以前的粗浅理解就是由 unicode 支持的表情字符，这次认真查了下，找到了一篇讲解很详尽的文章：Everything you need to know about emoji
根据里面的介绍，关于 emoji 比较官方的解释：
 Emoji are pictographs (pictorial symbols) that are typically presented in a colorful form and used inline in text. They represent things such as faces, weather, vehicles and buildings, food and drink, animals and plants, or icons that represent emotions, feelings, or activities.
 而 emoji 是怎么来的呢：">
<meta name="author" content="">
<link rel="canonical" href="https://www.iamgodot.com/posts/use-emoji-in-mysql/" />
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.d156b151269ca9f254ecd6e4c592b19e37346165a46b1b794368e59b7a6d3f36.css" integrity="sha256-0VaxUSacqfJU7NbkxZKxnjc0YWWkaxt5Q2jlm3ptPzY=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://www.iamgodot.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://www.iamgodot.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://www.iamgodot.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://www.iamgodot.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://www.iamgodot.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.83.1" />
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.iamgodot.com" accesskey="h" title="Godot&#39;s Blog (Alt + H)">Godot&#39;s Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://www.iamgodot.com/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://www.iamgodot.com/archive/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://www.iamgodot.com/categories/code/" title="Code">
                    <span>Code</span>
                </a>
            </li>
            <li>
                <a href="https://www.iamgodot.com/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Use emoji in MySQL
    </h1>
    <div class="post-meta">November 21, 2020&nbsp;·&nbsp;1 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#whats-emoji-" aria-label="What&amp;rsquo;s emoji 🧐">What&rsquo;s emoji 🧐</a></li>
                <li>
                    <a href="#charset-in-mysql" aria-label="Charset in MySQL">Charset in MySQL</a></li>
                <li>
                    <a href="#more-charset-in-mysql" aria-label="More charset in MySQL">More charset in MySQL</a></li>
                <li>
                    <a href="#django-settings" aria-label="Django settings">Django settings</a></li>
                <li>
                    <a href="#end" aria-label="End">End</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>最近碰到一个服务器处理请求报错，但是本身的代码逻辑没有问题，排查后发现原来是参数中包含了 emoji，导致向 MySQL 插入数据时失败了。</p>
<p>解决起来倒是不麻烦，因为业务上不要求做相关的支持，所以捕捉异常之后返回错误码也就好了。但是好奇之下，做了个 MySQL 插入 emoji 的实验，发现里面还是有不少门道的。</p>
<h1 id="whats-emoji-">What&rsquo;s emoji 🧐<a hidden class="anchor" aria-hidden="true" href="#whats-emoji-">#</a></h1>
<p>以前的粗浅理解就是由 unicode 支持的表情字符，这次认真查了下，找到了一篇讲解很详尽的文章：<a href="https://www.smashingmagazine.com/2016/11/character-sets-encoding-emoji/">Everything you need to know about emoji</a></p>
<p>根据里面的介绍，关于 emoji 比较官方的解释：</p>
<blockquote>
<p>Emoji are pictographs (pictorial symbols) that are typically presented in a colorful form and used inline in text. They represent things such as faces, weather, vehicles and buildings, food and drink, animals and plants, or icons that represent emotions, feelings, or activities.</p>
</blockquote>
<p>而 emoji 是怎么来的呢：</p>
<blockquote>
<p>Emoji are &ldquo;picture characters&rdquo; originally associated with cellular telephone usage in Japan, but now popular worldwide. The word emoji comes from the Japanese 絵 (e ≅ picture) + 文字 (moji ≅ written character).</p>
</blockquote>
<p>最关键的是，emoji 需要 4 个字节来表示，所以如果 MySQL 使用的是普通 utf8 字符集的话，是不足以表达一个 emoji 的信息的，所以自然会插入失败。</p>
<h1 id="charset-in-mysql">Charset in MySQL<a hidden class="anchor" aria-hidden="true" href="#charset-in-mysql">#</a></h1>
<p>从 MySQL 的官方解释看，utf8mb4 支持最多每个字符四字节的编码方式，而对于超出 BMP（简单来说就是绝大部分的文字和符号字符，参考<a href="https://en.wikipedia.org/wiki/Plane_(Unicode)">维基百科</a>）范围的字符（比如 emojis），utf8mb3（也就是 utf8）是不够用的，所以要使用 utf8mb4 才可以。</p>
<p><img loading="lazy" src="https://static.iamgodot.com/content/images/2242299f3a78a9008c42e9162d4c31ee.png" alt=""  />
</p>
<p>另外在 MySQL 中，charset 是有多个层级的设置的，所以如果需求明确的话，可以只对必要的 column/table 使用 utf8mb4，毕竟新的字符集也是要占用更多空间的。</p>
<p>如果想一步到位也是可以的，需要注意的是，MySQL 对字符集的设置大概分成下面几层，从上到下粒度也从大到小，而每一级如果没有显式设定的话会默认使用上一级的配置：</p>
<ul>
<li>character_set_server</li>
<li>character_set_database</li>
<li>table charset</li>
<li>column charset</li>
</ul>
<p>前两者可以使用 <code>show variables like &quot;character%&quot;;</code> 查看，而后面两个则从数据表的创建语句中体现 <code>show create table t_name;</code>.</p>
<h1 id="more-charset-in-mysql">More charset in MySQL<a hidden class="anchor" aria-hidden="true" href="#more-charset-in-mysql">#</a></h1>
<p>按理说完成上面的步骤之后，字段就可以完美支持 emoji 的插入了。但是打开一个客户端尝试插入 emoji 发现仍然会失败：</p>
<p><img loading="lazy" src="https://static.iamgodot.com/content/images/4ba81444f24f7e49aecb7cbf9f8605f1.png" alt=""  />
</p>
<p>原因是还有其他的 charset 没有设置正确，通过查看变量可以确认：</p>
<p><img loading="lazy" src="https://static.iamgodot.com/content/images/f052fdc1a96804c876dc089077cdd657.png" alt=""  />
</p>
<p>character_set_client 和 character_set_connection 这两项使用的还是 utf8，它们控制的是客户端在交互和传输过程中使用的字符集，更新之后插入成功，但是查询发现结果并没有展示正常的 emoji，而是表示乱码的问号：</p>
<p><img loading="lazy" src="https://static.iamgodot.com/content/images/66ff09d89c59a36755278c296462ae09.png" alt=""  />
</p>
<p>这是因为还有一项 charset 没有设置正确，即 character_set_results，这是服务器在回传响应时使用的字符集，所以虽然成功储存了数据，但是展示出来却面目全非。直接更新设置，再次查询便一切正常了：</p>
<p><img loading="lazy" src="https://static.iamgodot.com/content/images/9bca21f21f1dc99235efa27a1e51e1d3.png" alt=""  />
</p>
<h1 id="django-settings">Django settings<a hidden class="anchor" aria-hidden="true" href="#django-settings">#</a></h1>
<p>在服务器开发中，通常与数据库交互的客户端都是服务器应用，所以也应当确保在代码或者框架中配置的 charset 是正确的。</p>
<p>在 Django 中是通过 DATABASES OPTIONS 来指定连接数据库使用的字符集的（针对 MySQL），示例如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">DATABASES <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#34;default&#34;</span>: {
        <span style="color:#75715e"># ...</span>
        <span style="color:#e6db74">&#34;OPTIONS&#34;</span>: {
            <span style="color:#e6db74">&#34;charset&#34;</span>: <span style="color:#e6db74">&#34;utf8mb4&#34;</span>,
            <span style="color:#75715e"># ...</span>
        }
    }
}
</code></pre></div><h1 id="end">End<a hidden class="anchor" aria-hidden="true" href="#end">#</a></h1>
<p>另外在查找资料的过程中还发现有其他的实现思路，比如如果不想改动数据库的话，可以在应用层进行转换，核心思想就是维护一个 emoji 和普通字符串的对应关系，然后把转换结果存储入数据表，这样的好处就是不破坏已有数据库的状态，同时对于应用层的转换逻辑也可以有更加灵活的控制。</p>
<p>当然，最好的做法还是在一开始对需求本身做好分析，如果有确定的存储要求，比如用户名或者评论应当支持 emoji，那么在建表时就直接使用类似 utf8mb4 的新式字符集，一劳永逸。</p>


  </div>

  <footer class="post-footer">
<nav class="paginav">
  <a class="prev" href="https://www.iamgodot.com/posts/the-silverlining/">
    <span class="title">« Prev Page</span>
    <br>
    <span>生命之光</span>
  </a>
  <a class="next" href="https://www.iamgodot.com/posts/the-art-of-readable-code/">
    <span class="title">Next Page »</span>
    <br>
    <span>The Art of Readable Code</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2021 <a href="https://www.iamgodot.com">Godot&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><footer class="footer">
    <span>
        <a href="http://beian.miit.gov.cn/" target="_blank">京ICP备20005558号-2</a>
    </span>
</footer>


<script>
    let menu = document.getElementById('menu')
    menu.scrollLeft = localStorage.getItem("menu-scroll-position");
    menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
